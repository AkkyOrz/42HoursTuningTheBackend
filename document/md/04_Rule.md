# 採点とレギュレーション
## 採点方法について
チューニング結果を各チームのVMに反映し、[評価スクリプト](./99_manual.md#%E8%A9%95%E4%BE%A1)をそれぞれのVM内で実行することで採点ができます。

評価スクリプトでは、以下のプロセスで採点します。
- Step1. データベース、および添付ファイルを初期状態に戻す(顧客データをセット)
- Step2. [簡易DBマイグレーションの実行](./99_manual.md#%E7%B0%A1%E6%98%93db%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%A9%9F%E8%83%BD)
- Step3. API動作テストの実施
- Step4. 負荷試験の実施
- Step5. スコアの計算
- Step6. スコアの表示

Step3では[API仕様書](./98_api.md)をベースに、主要な要件を満たしているかをチェックします。問題があった場合はスコアを減点、あるいは0点になります。

Step4では一定時間各APIに対して多数のリクエストを行い、処理できたリクエスト数をベースにスコアが計算されます。

Step6で画面に表示されたスコアが、その時点のチームの持ち点になります。

*スコア上位グループについては、成果物に対して追加で審議される場合があります。

## レギュレーション
「本番稼働開始済みの業務アプリケーション」に対するパフォーマンス改善を行うことが原則です。

以下の行為は減点、0点、あるいは失格の対象となる場合があります。
- 原則を大きく逸脱した、極端な最適化を行うこと
  - API動作テストはPASSするが、業務アプリとして実質使えなくなるような最適化はNGです。
  - 微妙なラインの場合は、審議する場合があります。
- 初期データ(顧客データ)を欠損させる最適化
  - データを消して高速化するなど。顧客データはAPIを通して引き続き利用できなければいけません。
  - ただし画像については、UI上十分機能する場合に限り、変換や圧縮を認めます
  - データの保管方法は問いません。(MySQLの中身を全てテキストファイルに移行したとしても、APIからデータのやりとりが引き続きできるなら要件を満たしていると言えます。)
  - 改善の過程で、検証のためにデータを変更したり削除してみる行為は問題ありません
- UIが明らかに変わるような仕様変更
- [マニュアルに](./99_manual.md)記載された、環境の制約事項を利用する最適化
- 採点中に提供された環境以外のリソースを利用し、処理能力を上げること(例: 個人PCでリクエスト処理を代替する)
- 採点モジュールの改ざん、または不具合を悪用し不当にスコアを上げること
- 他チームの環境にログイン、コードを変更、DOS攻撃等の妨害行為
- 他チームと結託すること。他チームの環境にログインする、リポジトリを見るなどのカンニング行為
- その他、主催者側が不適切と判断した行為

「これはOK?」と思った時は、[マニュアル](./99_manual.md)を参照してください。

## 評価スクリプトの動作詳細
### Step4の補足
Step4では、負荷試験ツール「locust」を用いて、{環境ID}.ftt2204.dabaas.netに対してHTTPS接続で負荷試験を2分間実施します。

試験開始後徐々に接続が確立、ピーク時には390接続が確立され、それぞれの接続からAPIが呼び出されます。1接続では特定のAPIに対しリクエストを行い、レスポンスを受け取った後0.9秒経過後に再びリクエストを行う、という動作を繰り返します。リクエストのタイムアウト時間は50秒です。

それぞれのAPIはStep4実施中、同時にテストがされていることに注意してください。一つ一つのAPIを順番にテストしているわけではありません。

### Step5の補足
Step5では、さらに以下のステップでスコアが求められます。
- Step5-1. Step4.の結果から、各APIの成功応答回数を求める
- Step5-2. 5-1.の結果から、失敗回数が最も多いAPIの失敗応答回数(X)を求める
- Step5-3. それぞれのAPIについてceil(成功回数*補正係数)を求め、全API分を合計した値をベーススコアとする
- Step5-4. floor(X/100) > 0の場合、リクエスト失敗が多くユーザ体験を損なったとみなされ、減点される
  - floor(X/100)回数分、以下の減点処理がされる
  - 現在のベーススコアからfloor(現在のベーススコア* 0.12)減点し、その結果をベーススコアとする。
- Step5-5. この時点のベーススコアを最終的なスコアとする

補正係数:

|API名|値|
|--|--|
|GET /categories|0.7|
|POST /files|1.5|
|GET /record-views/allActive|2|
|GET /record-views/allClosed|2|
|GET /record-views/mineActive|1.5|
|GET /record-views/tomeActive|3|
|POST /records|1.2|
|GET /records/[recordId]|1|
|PUT /records/[recordId]|0.8|
|GET /records/[recordId]/comments|0.9|
|POST /records/[recordId]/comments|1|
|GET /records/[recordId]/files/[itemId]|1|
|GET /records/[recordId]/files/[itemId]/thumbnail|1|

[次へ](./10_end.md)
